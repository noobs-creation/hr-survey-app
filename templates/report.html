<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HR Executive Summary</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 40px; background: #f9f9f9; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        h1 { color: #003366; text-align: center; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 40px; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .kpi-card { background: #f4f6f8; padding: 20px; text-align: center; border-radius: 8px; border: 1px solid #ddd; }
        .kpi-val { font-size: 2em; font-weight: bold; color: #003366; display: block; margin-bottom: 5px; }
        .kpi-label { font-size: 0.9em; color: #555; text-transform: uppercase; letter-spacing: 1px; }

        /* AI Section (New) */
        .ai-section { margin-bottom: 40px; background: #f0f7ff; border: 1px solid #cce5ff; border-radius: 8px; padding: 30px; }
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #dae9fa; padding-bottom: 15px; }
        .btn-ai { background: linear-gradient(135deg, #003366 0%, #0055aa 100%); color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px; transition: opacity 0.2s; font-size: 1em; }
        .btn-ai:hover { opacity: 0.9; }
        
        .ai-content { font-size: 1em; line-height: 1.6; color: #444; }
        .ai-content h3 { margin-top: 25px; font-size: 1.2em; color: #003366; border-left: 5px solid #003366; padding-left: 10px; }
        .ai-content ul { padding-left: 20px; }

        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #003366; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Chart Layout */
        .chart-section { display: flex; gap: 40px; margin-bottom: 40px; align-items: center; }
        .radar-box { flex: 1; }
        .bar-box { flex: 1; }

        .footer { text-align: center; margin-top: 50px; font-size: 0.8em; color: #999; border-top: 1px solid #eee; padding-top: 20px; }
        
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
            .btn-ai { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Organization Culture Report</h1>
    <div class="subtitle">Generated on {{ timestamp }} (IST)</div>

    <div class="kpi-grid">
        <div class="kpi-card">
            <span class="kpi-val">{{ overall }} / 5.0</span>
            <span class="kpi-label">Engagement Score</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-val">{{ total }}</span>
            <span class="kpi-label">Total Responses</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-val" style="color: #28a745;">{{ strongest[0] }}</span>
            <span class="kpi-label">Top Strength</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-val" style="color: #dc3545;">{{ weakest[0] }}</span>
            <span class="kpi-label">Needs Focus</span>
        </div>
    </div>

    <div class="ai-section">
        <div class="ai-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="ph ph-brain" style="font-size: 1.8em; color: #003366;"></i>
                <div>
                    <strong style="color: #003366; font-size: 1.2em;">AI Strategic Consultant</strong>
                    <div style="font-size: 0.85em; color: #666;">Deep analysis of organizational trends and culture</div>
                </div>
            </div>
            <button class="btn-ai" onclick="generateReport()">
                <i class="ph ph-sparkle"></i> Generate Insight
            </button>
        </div>
        
        <div id="loader" style="display: none; align-items: center; gap: 10px; color: #666; justify-content: center; padding: 20px;">
            <div class="loader" style="display: block;"></div> 
            Analyzing company-wide data patterns...
        </div>

        <div id="ai-result" class="ai-content"></div>
    </div>

    <div class="chart-section">
        <div class="radar-box">
            <h3 style="text-align: center; color: #444;">Category Balance</h3>
            <canvas id="radarChart"></canvas>
        </div>
        <div class="bar-box">
            <h3 style="text-align: center; color: #444;">Detailed Scores</h3>
            <canvas id="barChart"></canvas>
        </div>
    </div>

    <div class="footer">
        Confidential Internal Report â€¢ Do not distribute externally.
    </div>
</div>

<script>
    // Data passed from Flask
    const categories = {{ averages.keys()|list|tojson }};
    const scores = {{ averages.values()|list|tojson }};

    // 1. Radar Chart Configuration
    const ctxRadar = document.getElementById('radarChart').getContext('2d');
    new Chart(ctxRadar, {
        type: 'radar',
        data: {
            labels: categories,
            datasets: [{
                label: 'Score (out of 5)',
                data: scores,
                backgroundColor: 'rgba(0, 51, 102, 0.2)',
                borderColor: 'rgba(0, 51, 102, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(0, 51, 102, 1)'
            }]
        },
        options: {
            scales: {
                r: { min: 0, max: 5, ticks: { stepSize: 1 } }
            }
        }
    });

    // 2. Bar Chart Configuration
    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: categories,
            datasets: [{
                label: 'Average Score',
                data: scores,
                backgroundColor: scores.map(s => s >= 4 ? '#28a745' : (s < 3 ? '#dc3545' : '#003366')),
            }]
        },
        options: {
            indexAxis: 'y',
            scales: { x: { min: 0, max: 5 } },
            plugins: { legend: { display: false } }
        }
    });

    // 3. AI Report Generation Logic
    async function generateReport() {
        const resultBox = document.getElementById('ai-result');
        const loader = document.getElementById('loader');
        
        loader.style.display = 'flex';
        resultBox.innerHTML = '';
        
        try {
            const response = await fetch('/analyze_aggregate');
            const data = await response.json();
            
            if (data.analysis) {
                resultBox.innerHTML = data.analysis;
            } else {
                resultBox.innerHTML = `<span style="color:red">Error: ${data.error}</span>`;
            }
        } catch (error) {
            resultBox.innerHTML = `<span style="color:red">Connection Error. Please try again.</span>`;
        } finally {
            loader.style.display = 'none';
        }
    }
</script>

</body>
</html>